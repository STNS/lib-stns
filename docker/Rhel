FROM centos:latest

# install go
RUN yum install -y wget rpmdevtools make git gcc
RUN wget https://storage.googleapis.com/golang/go1.5.2.linux-amd64.tar.gz -P /tmp;tar zxvf /tmp/go1.5.2.linux-amd64.tar.gz -C /usr/local
ENV GOPATH /go
ENV PATH $PATH:/usr/local/go/bin:$GOPATH/bin

# libnss_stns
ADD ./ /go/src/github.com/pyama86/libnss_stns
RUN chown root:root -R /go/src/github.com/pyama86/libnss_stns/package/RPM;echo '%_topdir /go/src/github.com/pyama86/libnss_stns/package/RPM' > ~/.rpmmacros


WORKDIR /go/src/github.com/pyama86/libnss_stns
RUN cp build/rhel/ssh_stns_wrapper package/RPM/BUILD/;go get github.com/tools/godep;godep restore
RUN go build -buildmode=c-shared -o package/RPM/BUILD/libnss_stns.so libnss_stns.go entry.go passwd.go shadow.go group.go
CMD rpmbuild -ba package/RPM/SPECS/libnss_stns.spec;mv package/RPM/RPMS/noarch/*rpm releases/
